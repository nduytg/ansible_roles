---
# Setup Grafana
- name: get all ip
  ansible.builtin.debug:
    var: ansible_all_ipv4_addresses

- name: get default ip
  ansible.builtin.debug: 
    var: ansible_default_ipv4.address

- name: Add Grafana repo
  ansible.builtin.apt_repository: 
    repo: deb https://packages.grafana.com/oss/deb stable main
    state: present

- name: Add Grafana Key
  ansible.builtin.apt_key:
    url: https://packages.grafana.com/gpg.key
    state: present

- name: Install Grafana
  ansible.builtin.apt: 
    update_cache: yes
    name: 
      - grafana
      - apt-transport-https
    state: present

- name: Copy grafana.ini file
  ansible.builtin.template:
    src: grafana.ini.j2
    dest: /etc/grafana/grafana.ini

- name: Start Grafana
  ansible.builtin.systemd:
    name: grafana-server
    state: started
    daemon_reload: yes
    enabled: yes

- name: Allow intra net access to grafana
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '3000'
    jump: ACCEPT

- name: Save iptables rules to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    line: '-A INPUT -s 10.0.0.0/8 -p tcp -m tcp --dport 3000 -j ACCEPT'
    


    
