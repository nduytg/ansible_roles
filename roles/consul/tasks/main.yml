---
# tasks file for consul
- name: get all ip
  ansible.builtin.debug: 
    var: ansible_all_ipv4_addresses

- name: get default ip
  ansible.builtin.debug: 
    var: ansible_default_ipv4.address

- name: Add group Consul
  ansible.builtin.group: 
    name: consul
    state: present

- name: Add user Consul
  ansible.builtin.user: 
    name: consul
    group: consul
    state: present
    shell: /usr/sbin/nologin
    create_home: false

- name: Setup Consul folders
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: consul
    group: consul
  loop:
    - /opt/consul
    - /var/consul
    - /etc/consul.d

- name: Install unzip command
  ansible.builtin.yum: 
    update_cache: yes
    name: 
      - unzip
    state: present

- name: Download consul tar ball
  ansible.builtin.get_url: 
    url: https://releases.hashicorp.com/consul/{{CONSUL_VERSION}}/consul_{{CONSUL_VERSION}}_linux_amd64.zip
    dest: /opt/consul/consul_{{CONSUL_VERSION}}_linux_amd64.zip

- name: Unzip consul zip file
  ansible.builtin.unarchive:
    src: /opt/consul/consul_{{CONSUL_VERSION}}_linux_amd64.zip
    dest: /opt/consul/
    remote_src: yes

- name: Copy binary files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: yes
    owner: consul
    group: consul
    mode: '0755'
  loop:
    - { src: '/opt/consul/consul', dest: '/usr/local/bin/' }
  notify:
    - restart consul

- name: Copy config for consul stand alone
  ansible.builtin.template:
    src: consul_one_node.json.j2
    dest: /etc/consul.d/consul.json
    owner: consul
    group: consul
  when: not CONSUL_CLUSTER | bool
  notify:
  - reload consul

- name: Copy config for consul cluster
  ansible.builtin.template:
    src: consul_cluster.json.j2
    dest: /etc/consul.d/consul.json
    owner: consul
    group: consul
  when: CONSUL_CLUSTER | bool
  notify:
  - reload consul

- name: Copy systemd file
  ansible.builtin.copy:
    src: consul.service
    dest: /etc/systemd/system/consul.service
  notify:
    - restart consul

- name: Allow intra net access to Consul TCP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '8300'
    jump: ACCEPT

- name: Allow intra net access to Consul LAN Gossip TCP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '8301'
    jump: ACCEPT

- name: Allow intra net access to Consul WAN Gossip TCP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '8302'
    jump: ACCEPT

- name: Allow intra net access to Consul LAN Gossip UDP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: udp
    source: 10.0.0.0/8
    destination_port: '8301'
    jump: ACCEPT

- name: Allow intra net access to Consul WAN Gossip UDP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: udp
    source: 10.0.0.0/8
    destination_port: '8302'
    jump: ACCEPT

- name: Allow intra net access to Consul TCP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '8300'
    jump: ACCEPT

- name: Allow intra net access to Consul HTTP API
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '8500'
    jump: ACCEPT

- name: Allow intra net access to Consul DNS TCP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    source: 10.0.0.0/8
    destination_port: '8600'
    jump: ACCEPT

- name: Allow intra net access to Consul DNS UDP
  ansible.builtin.iptables:
    chain: INPUT
    protocol: udp
    source: 10.0.0.0/8
    destination_port: '8600'
    jump: ACCEPT

- name: Save iptables rules port 8300 to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p tcp -m tcp --dport 8300 -j ACCEPT'

- name: Save iptables rules port 8301 TCP to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p tcp -m tcp --dport 8301 -j ACCEPT'

- name: Save iptables rules port 8302 TCP to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p tcp -m tcp --dport 8302 -j ACCEPT'

- name: Save iptables rules port 8500 to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p tcp -m tcp --dport 8500 -j ACCEPT'

- name: Save iptables rules port 8600 to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p tcp -m tcp --dport 8600 -j ACCEPT'

- name: Save iptables rules port 8301 UDP to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p udp --dport 8301 -j ACCEPT'

- name: Save iptables rules port 8302 UDP to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p udp --dport 8302 -j ACCEPT'

- name: Save iptables rules port 8600  UDP to /etc/sysconfig/iptables
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/iptables
    insertafter: '^# END SA MANAGED BLOCK '
    line: '-A INPUT -s 10.0.0.0/8 -p udp --dport 8600 -j ACCEPT'
